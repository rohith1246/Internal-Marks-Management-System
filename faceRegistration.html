<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Registration</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #video { border: 2px solid #000; margin: 20px; }
        #canvas { display: none; }
        #status { margin: 20px; font-size: 18px; color: #333; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        #userInfo { margin: 20px; font-size: 16px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Face Registration</h1>
    <p>Please position your face in the camera frame, ensure good lighting, and click Capture.</p>
    
    <div id="userInfo">
        <p>User ID: <span id="userId">-</span></p>
        <p>Type: <span id="userType">-</span></p>
    </div>
    
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas"></canvas>
    
    <div id="status">Starting Camera...</div>
    
    <button id="captureBtn">Capture Images</button>
    <button id="tryAgainBtn" disabled>Try Again</button>
    <button id="backBtn" onclick="window.location.href='login.html'">Back to Login</button>
    
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const status = document.getElementById('status');
        const userIdEl = document.getElementById('userId');
        const userTypeEl = document.getElementById('userType');
        
        let stream;
        let images = [];

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const userType = urlParams.get('userType');
        const token = urlParams.get('token');

        // Display user info
        userIdEl.textContent = userId || '-';
        userTypeEl.textContent = userType || '-';

        // Validate token
        async function validateToken() {
            try {
                const response = await fetch(`http://localhost:3000/validate-token?userId=${userId}&userType=${userType}&token=${token}`);
                const result = await response.json();
                if (!result.valid) {
                    status.textContent = 'Invalid or expired token';
                    status.className = 'error';
                    captureBtn.disabled = true;
                }
            } catch (err) {
                status.textContent = 'Error validating token: ' + err.message;
                status.className = 'error';
                captureBtn.disabled = true;
            }
        }

        // Start webcam
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                status.textContent = 'Camera started. Ensure good lighting, position your face, and click Capture.';
                captureBtn.disabled = false;
            } catch (err) {
                status.textContent = 'Error accessing camera: ' + err.message;
                status.className = 'error';
                captureBtn.disabled = true;
            }
        }

        // Capture multiple images
        async function captureImages() {
            captureBtn.disabled = true;
            status.textContent = 'Capturing images... Please hold still.';
            status.className = '';
            images = [];

            const captureInterval = setInterval(() => {
                if (images.length >= 20) { // Increased to 20 images
                    clearInterval(captureInterval);
                    sendImages();
                    return;
                }
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                images.push(canvas.toDataURL('image/jpeg', 0.8));
                status.textContent = `Captured ${images.length} of 20 images...`;
            }, 500);
        }

        // Send images to server
        async function sendImages() {
            try {
                const response = await fetch('http://127.0.0.1:5001/api/face-register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        userType,
                        images
                    })
                });
                const result = await response.json();
                if (result.success) {
                    status.textContent = `${result.message} Training status: ${result.training_status}`;
                    status.className = 'success';
                    tryAgainBtn.disabled = false;
                } else {
                    status.textContent = `Error: ${result.error}`;
                    status.className = 'error';
                    tryAgainBtn.disabled = false;
                }
            } catch (err) {
                status.textContent = 'Error sending images: ' + err.message;
                status.className = 'error';
                tryAgainBtn.disabled = false;
            }
        }

        // Event listeners
        captureBtn.addEventListener('click', captureImages);
        tryAgainBtn.addEventListener('click', () => {
            images = [];
            status.textContent = 'Ready to capture again. Ensure good lighting and click Capture.';
            status.className = '';
            captureBtn.disabled = false;
            tryAgainBtn.disabled = true;
        });

        // Initialize
        if (userId && userType && token) {
            validateToken();
            startCamera();
        } else {
            status.textContent = 'Missing userId, userType, or token';
            status.className = 'error';
            captureBtn.disabled = true;
        }
    </script>
</body>
</html>