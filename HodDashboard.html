<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD Dashboard</title>
    <!-- Add in head section -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Global styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: #2c3e50;
            color: #fff;
            padding: 20px;
            box-sizing: border-box;
        }

        .sidebar h2 {
            margin-top: 0;
        }

        .sidebar a {
            display: block;
            color: #fff;
            text-decoration: none;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .sidebar a:hover {
            background-color: #34495e;
        }

        .sidebar a.active {
            background-color: #3498db;
        }

        #logout-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #fff;
            text-decoration: none;
        }

        /* Main content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .header {
            background-color: #fff;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .content-section {
            display: none;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* Buttons */
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 5px;
        }

        .btn-primary {
            background-color: #3498db;
            color: #fff;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-warning {
            background-color: #f39c12;
            color: #fff;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: #fff;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: #fff;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }

        .modal-header {
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            box-sizing: border-box;
        }

        /* Timetable grid in modal */
        #timetable-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        #timetable-grid .header,
        #timetable-grid .day,
        #timetable-grid .slot {
            min-width: 120px; 
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
            background-color: #fff;
        }

        #timetable-grid .header,
        #timetable-grid .day {
            font-weight: bold;
            background-color: #f4f4f4;
        }

        #timetable-grid .slot {
            cursor: pointer;
        }

        #timetable-grid .slot:hover {
            background-color: #f0f0f0;
        }

        #timetable-grid .lunchbreak {
            background-color: #ecf0f1;
            cursor: default;
        }

        /* Slot input container */
        .slot-input-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .slot-input-container > div {
            flex: 1;
            margin-right: 10px;
        }

        .slot-input-container button {
            margin-left: 10px;
        }

        /* Timetable cards */
        .timetable-card {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .timetable-card h3 {
            margin-top: 0;
        }

        table.timetable-grid {
            width: 100%;
            border-collapse: collapse;
        }

        table.timetable-grid th,
        table.timetable-grid td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }

        table.timetable-grid th {
            background-color: #f4f4f4;
            font-weight: bold;
        }

        table.timetable-grid td {
            background-color: #fff;
        }

        /* Responsive design */
    /* Remove the problematic media query */
@media (max-width: 768px) {
    /* Remove the grid-template-columns override */
    #timetable-grid {
        grid-template-columns: 100px repeat(8, 1fr); /* Maintain same grid structure */
    }
}
/* Add these styles to your existing CSS */

/* Edit button specific styling */
.btn-edit {
    background-color: #f39c12; /* Orange */
    color: white;
}

.btn-edit:hover {
    background-color: #e67e22; /* Darker orange */
}

/* Delete button specific styling */
.btn-delete {
    background-color: #e74c3c; /* Red */
    color: white;
}

.btn-delete:hover {
    background-color: #c0392b; /* Darker red */
}

/* Timetable card action buttons */
.timetable-card button {
    margin: 5px;
    padding: 6px 12px;
    font-size: 0.9em;
}

/* Align action buttons in tables */
table td .btn {
    margin: 2px;
    padding: 4px 8px;
    font-size: 0.85em;
}

/* Button group alignment */
.button-group {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}
</style>
</head>
<body>
    <div class="sidebar">
        <div>
            <h2>HOD Dashboard</h2>
            <a href="#" class="nav-link" data-section="subjects-section">Subjects</a>
            <a href="#" class="nav-link" data-section="students-section">Students</a>
            <a href="#" class="nav-link" data-section="faculty-section">Faculty</a>
            <a href="#" class="nav-link active" data-section="timetables-section">Timetables</a>
            <a href="#" class="nav-link" data-section="marks-section">View Marks</a>
        </div>
        <a href="/" id="logout-btn">Logout</a>
    </div>
    <div class="main-content">
        <div class="header">
            <h1>Welcome, <span id="hod-name"></span> (HOD, <span id="hod-dept"></span>)</h1>
        </div>

        <!-- Subjects Section -->
        <div id="subjects-section" class="content-section">
            <h2>Manage Subjects</h2>
            <button class="btn btn-primary" onclick="openModal('add-subject-modal')">
                <i class="fas fa-plus"></i> Add Subject
            </button>
            <div class="form-group">
                <label for="subject-course-filter">Course</label>
                <select id="subject-course-filter" class="form-control">
                    <option value="B.Tech">B.Tech</option>
                    <option value="M.Tech">M.Tech</option>
                </select>
            </div>
            <div class="form-group">
                <label for="subject-semester-filter">Semester</label>
                <select id="subject-semester-filter" class="form-control">
                    <option value="">All Semesters</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>
            </div>
            <div class="table-container">
                <table id="subjects-table">
                    <thead>
                        <tr>
                            <th>Subject ID</th>
                            <th>Subject Name</th>
                            <th>Semester</th>
                            <th>Course</th>
                            <th>Assigned Faculty</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Timetables Section -->
        <div id="timetables-section" class="content-section active">
            <h2>Manage Timetables</h2>
            <button class="btn btn-primary" onclick="openModal('create-timetable-modal')">
                <i class="fas fa-plus"></i> Create Timetable
            </button>
            <div class="form-group">
                <label for="upload-timetable-input">Import Timetable (CSV)</label>
                <input type="file" id="upload-timetable-input" class="form-control" accept=".csv">
            </div>
            <div class="form-group">
                <label for="timetable-type-filter">Filter by Type</label>
                <select id="timetable-type-filter" class="form-control">
                    <option value="">All</option>
                    <option value="faculty">Faculty Timetables</option>
                    <option value="semester">Semester Timetables</option>
                </select>
            </div>
            <div id="timetables-list"></div>
        </div>

        <!-- Students Section -->
        <div id="students-section" class="content-section">
            <h2>Manage Students</h2>
            <div class="form-group">
                <label for="student-course-filter">Course</label>
                <select id="student-course-filter" class="form-control">
                    <option value="B.Tech">B.Tech</option>
                    <option value="M.Tech">M.Tech</option>
                </select>
            </div>
            <div class="form-group">
                <label for="student-semester-filter">Semester</label>
                <select id="student-semester-filter" class="form-control">
                    <option value="">All Semesters</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>
            </div>
            <div class="table-container">
                <table id="students-table">
                    <thead>
                        <tr>
                            <th>Roll Number</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Semester</th>
                            <th>Course</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Faculty Section -->
        <div id="faculty-section" class="content-section">
            <h2>Manage Faculty</h2>
            <button class="btn btn-primary" onclick="openModal('add-faculty-modal')">
                <i class="fas fa-plus"></i> Add Faculty
            </button>
            <div class="table-container">
                <table id="faculty-table">
                    <thead>
                        <tr>
                            <th>Faculty ID</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Marks Section -->
        <div id="marks-section" class="content-section">
            <h2>View Marks</h2>
            <div class="form-group">
                <label for="marks-semester-filter">Semester</label>
                <select id="marks-semester-filter" class="form-control">
                    <option value="">Select Semester</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>
            </div>
            <div class="form-group">
                <label for="marks-course-filter">Course</label>
                <select id="marks-course-filter" class="form-control">
                    <option value="B.Tech">B.Tech</option>
                    <option value="M.Tech">M.Tech</option>
                </select>
            </div>
            <div class="form-group">
                <label for="marks-subject-filter">Subject</label>
                <select id="marks-subject-filter" class="form-control">
                    <option value="">Select Subject</option>
                </select>
            </div>
            <div class="table-container">
                <table id="marks-table">
                    <thead>
                        <tr>
                            <th>Roll Number</th>
                            <th>Subject ID</th>
                            <th>Subject Name</th>
                            <th>Semester</th>
                            <th>Assignment 1</th>
                            <th>Assignment 2</th>
                            <th>Assignment 3</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Add Subject Modal -->
        <div id="add-subject-modal" class="modal" role="dialog" aria-labelledby="add-subject-title">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="add-subject-title">Add Subject</h3>
                </div>
                <form id="add-subject-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="subject-id">Subject ID</label>
                            <input type="text" id="subject-id" name="subjectId" class="form-control" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="subject-name">Subject Name</label>
                            <input type="text" id="subject-name" name="subjectName" class="form-control" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="subject-semester">Semester</label>
                            <select id="subject-semester" name="semester" class="form-control" required aria-required="true">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="subject-course">Course</label>
                            <select id="subject-course" name="course" class="form-control" required aria-required="true">
                                <option value="B.Tech">B.Tech</option>
                                <option value="M.Tech">M.Tech</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="subject-faculty">Assign Faculty (Optional)</label>
                            <select id="subject-faculty" name="facultyId" class="form-control">
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-subject-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Subject Modal -->
        <div id="edit-subject-modal" class="modal" role="dialog" aria-labelledby="edit-subject-title">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="edit-subject-title">Edit Subject</h3>
                </div>
                <form id="edit-subject-form">
                    <div class="modal-body">
                        <input type="hidden" id="edit-subject-id" name="subjectId">
                        <div class="form-group">
                            <label for="edit-subject-name">Subject Name</label>
                            <input type="text" id="edit-subject-name" name="subjectName" class="form-control" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="edit-subject-semester">Semester</label>
                            <select id="edit-subject-semester" name="semester" class="form-control" required aria-required="true">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-subject-course">Course</label>
                            <select id="edit-subject-course" name="course" class="form-control" required aria-required="true">
                                <option value="B.Tech">B.Tech</option>
                                <option value="M.Tech">M.Tech</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-subject-faculty">Assign Faculty (Optional)</label>
                            <select id="edit-subject-faculty" name="facultyId" class="form-control">
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('edit-subject-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Faculty Modal -->
        <div id="add-faculty-modal" class="modal" role="dialog" aria-labelledby="add-faculty-title">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="add-faculty-title">Add Faculty</h3>
                </div>
                <form id="add-faculty-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="faculty-id">Faculty ID</label>
                            <input type="text" id="faculty-id" name="facultyId" class="form-control" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="faculty-full-name">Full Name</label>
                            <input type="text" id="faculty-full-name" name="fullName" class="form-control" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="faculty-email">Email</label>
                            <input type="email" id="faculty-email" name="email" class="form-control" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="faculty-password">Password</label>
                            <input type="password" id="faculty-password" name="password" class="form-control" required aria-required="true">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('add-faculty-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Faculty Modal -->
        <div id="edit-faculty-modal" class="modal" role="dialog" aria-labelledby="edit-faculty-title">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="edit-faculty-title">Edit Faculty</h3>
                </div>
                <form id="edit-faculty-form">
                    <div class="modal-body">
                        <input type="hidden" id="edit-faculty-id" name="facultyId">
                        <div class="form-group">
                            <label for="edit-faculty-full-name">Full Name</label>
                            <input type="text" id="edit-faculty-full-name" name="fullName" class="form-control" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="edit-faculty-email">Email</label>
                            <input type="email" id="edit-faculty-email" name="email" class="form-control" required aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="edit-faculty-password">Password (Leave blank to keep unchanged)</label>
                            <input type="password" id="edit-faculty-password" name="password" class="form-control">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('edit-faculty-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Create Timetable Modal -->
        <div id="create-timetable-modal" class="modal" role="dialog" aria-labelledby="create-timetable-title">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="create-timetable-title">Create Timetable</h3>
                </div>
                <form id="create-timetable-form">
                    <div class="modal-body">
                        <input type="hidden" id="timetable-id" name="timetableId">
                        <div class="form-group">
                            <label for="create-timetable-type">Timetable Type</label>
                            <select id="create-timetable-type" name="type" class="form-control" required aria-required="true">
                                <option value="">Select Type</option>
                                <option value="faculty">Faculty Timetable</option>
                                <option value="semester">Semester Timetable</option>
                            </select>
                        </div>
                        <div class="form-group" id="create-faculty-select-group">
                            <label for="create-timetable-faculty-id">Faculty</label>
                            <select id="create-timetable-faculty-id" name="facultyId" class="form-control">
                                <option value="">Select Faculty</option>
                            </select>
                        </div>
                        <div class="form-group" id="create-semester-select-group" style="display: none;">
                            <label for="create-timetable-semester">Semester</label>
                            <select id="create-timetable-semester" name="semester" class="form-control">
                                <option value="">Select Semester</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Timetable Grid</label>
                            <div class="timetable-grid" id="timetable-grid"></div>
                        </div>
                        <div class="form-group slot-input-container" id="slot-input" style="display: none;">
                            <div>
                                <label for="slot-subject">Subject/Class</label>
                                <select id="slot-subject" class="form-control">
                                    <option value="">Select Subject</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="cancelSlotEdit()">Cancel</button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('create-timetable-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="timetable-submit-btn">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let hodDeptId = '';
        let defaultCourse = 'B.Tech';
        const days = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const timeSlots = ['9:30-10:20', '10:20-11:10', '11:20-12:10', '12:10-13:00', 'LUNCHBREAK', '13:40-14:30', '14:30-15:20', '15:20-16:10'];
        let availableSubjects = [];

        async function fetchWithErrorHandling(url, options = {}) {
            const response = await fetch(url, options);
            const contentType = response.headers.get('Content-Type');
            let data;

            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else {
                data = await response.text();
            }

            if (!response.ok) {
                throw new Error(data.error || data || `HTTP error! Status: ${response.status}`);
            }

            return data;
        }

        async function loadHODDetails() {
            try {
                const data = await fetchWithErrorHandling('/api/hod-details');
                document.getElementById('hod-name').textContent = data.hod_name;
                document.getElementById('hod-dept').textContent = data.dept_name;
                hodDeptId = data.dept_id;
                await Promise.all([
                    loadSubjects(),
                    loadStudents(),
                    loadFaculty(),
                    loadTimetables(),
                    loadSubjectsForMarks()
                ]);
            } catch (error) {
                console.error('Error loading HOD details:', error);
                alert(`Failed to load HOD details: ${error.message}. Please log in again.`);
                window.location.href = '/login.html';
            }
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.section).classList.add('active');
            });
        });

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            modal.querySelector('form')?.focus();
            if (modalId === 'create-timetable-modal') {
                initializeTimetableGrid();
                const isEditing = !!document.getElementById('timetable-id').value;
                document.getElementById('create-timetable-type').disabled = isEditing;
                document.getElementById('create-timetable-faculty-id').disabled = isEditing;
                document.getElementById('create-timetable-semester').disabled = isEditing;
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
            const form = modal.querySelector('form');
            if (form) form.reset();
            document.getElementById('timetable-id').value = '';
            document.getElementById('create-timetable-title').textContent = 'Create Timetable';
            document.getElementById('timetable-submit-btn').textContent = 'Save';
            document.getElementById('create-faculty-select-group').style.display = 'block';
            document.getElementById('create-semester-select-group').style.display = 'none';
            document.getElementById('slot-input').style.display = 'none';
        }

        async function loadSubjects() {
            try {
                const course = document.getElementById('subject-course-filter').value;
                const semester = document.getElementById('subject-semester-filter').value;
                const url = `/api/subjects?deptId=${encodeURIComponent(hodDeptId)}&course=${encodeURIComponent(course)}${semester ? `&semester=${semester}` : ''}`;
                const subjects = await fetchWithErrorHandling(url);
                const tbody = document.querySelector('#subjects-table tbody');
                tbody.innerHTML = subjects.map(subject => `
                    <tr>
                        <td>${subject.subject_id}</td>
                        <td>${subject.subject_name}</td>
                        <td>${subject.semester}</td>
                        <td>${subject.course}</td>
                        <td>${subject.assigned_faculty || 'None'}</td>
                        <td>
                            <button class="btn btn-warning" onclick='editSubject(${JSON.stringify(subject)})'>Edit</button>
                            <button class="btn btn-danger" onclick="deleteSubject('${subject.subject_id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading subjects:', error);
                alert(`Failed to load subjects: ${error.message}`);
            }
        }

        document.getElementById('add-subject-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            if (!data.subjectId.trim() || !data.subjectName.trim()) {
                alert('Subject ID and Name are required.');
                return;
            }
            data.deptId = hodDeptId;
            try {
                await fetchWithErrorHandling('/api/add-subject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                closeModal('add-subject-modal');
                await Promise.all([loadSubjects(), loadSubjectsForMarks()]);
            } catch (error) {
                console.error('Error adding subject:', error);
                alert(`Failed to add subject: ${error.message}`);
            }
        });

        function editSubject(subject) {
            const modal = document.getElementById('edit-subject-modal');
            modal.querySelector('#edit-subject-id').value = subject.subject_id;
            modal.querySelector('#edit-subject-name').value = subject.subject_name;
            modal.querySelector('#edit-subject-semester').value = subject.semester;
            modal.querySelector('#edit-subject-course').value = subject.course;
            modal.querySelector('#edit-subject-faculty').value = subject.assigned_faculty || '';
            openModal('edit-subject-modal');
        }

        document.getElementById('edit-subject-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            if (!data.subjectName.trim()) {
                alert('Subject Name is required.');
                return;
            }
            data.deptId = hodDeptId;
            try {
                await fetchWithErrorHandling('/api/update-subject', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                closeModal('edit-subject-modal');
                await Promise.all([loadSubjects(), loadSubjectsForMarks()]);
            } catch (error) {
                console.error('Error updating subject:', error);
                alert(`Failed to update subject: ${error.message}`);
            }
        });

        async function deleteSubject(subjectId) {
            if (!confirm('Are you sure you want to delete this subject?')) return;
            try {
                await fetchWithErrorHandling(`/api/delete-subject?subject_id=${encodeURIComponent(subjectId)}`, { method: 'DELETE' });
                await Promise.all([loadSubjects(), loadSubjectsForMarks()]);
            } catch (error) {
                console.error('Error deleting subject:', error);
                alert(`Failed to delete subject: ${error.message}`);
            }
        }

        async function loadStudents() {
            try {
                const course = document.getElementById('student-course-filter').value;
                const semester = document.getElementById('student-semester-filter').value;
                const url = `/api/hod-students?deptId=${encodeURIComponent(hodDeptId)}&course=${encodeURIComponent(course)}${semester ? `&semester=${semester}` : ''}`;
                const students = await fetchWithErrorHandling(url);
                const tbody = document.querySelector('#students-table tbody');
                tbody.innerHTML = students.map(student => `
                    <tr>
                        <td>${student.roll_number}</td>
                        <td>${student.full_name}</td>
                        <td>${student.email}</td>
                        <td>${student.semester}</td>
                        <td>${student.course}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading students:', error);
                alert(`Failed to load students: ${error.message}`);
            }
        }

        async function loadFaculty() {
            try {
                const faculty = await fetchWithErrorHandling(`/api/faculty?deptId=${encodeURIComponent(hodDeptId)}`);
                const tbody = document.querySelector('#faculty-table tbody');
                const subjectFacultySelect = document.getElementById('subject-faculty');
                const editSubjectFacultySelect = document.getElementById('edit-subject-faculty');
                const createTimetableFacultySelect = document.getElementById('create-timetable-faculty-id');
                tbody.innerHTML = faculty.map(f => `
                    <tr>
                        <td>${f.faculty_id}</td>
                        <td>${f.full_name}</td>
                        <td>${f.email}</td>
                        <td>
                            <button class="btn btn-warning" onclick='editFaculty(${JSON.stringify(f)})'>Edit</button>
                            <button class="btn btn-danger" onclick="deleteFaculty('${f.faculty_id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
                const facultyOptions = faculty.map(f => `<option value="${f.faculty_id}">${f.full_name}</option>`).join('');
                subjectFacultySelect.innerHTML = '<option value="">None</option>' + facultyOptions;
                editSubjectFacultySelect.innerHTML = '<option value="">None</option>' + facultyOptions;
                createTimetableFacultySelect.innerHTML = '<option value="">Select Faculty</option>' + facultyOptions;
            } catch (error) {
                console.error('Error loading faculty:', error);
                alert(`Failed to load faculty: ${error.message}`);
            }
        }

        document.getElementById('add-faculty-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            if (!data.facultyId.trim() || !data.fullName.trim() || !data.email.trim() || !data.password) {
                alert('All fields are required.');
                return;
            }
            data.deptId = hodDeptId;
            try {
                await fetchWithErrorHandling('/api/add-faculty', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                closeModal('add-faculty-modal');
                await loadFaculty();
            } catch (error) {
                console.error('Error adding faculty:', error);
                alert(`Failed to add faculty: ${error.message}`);
            }
        });

        function editFaculty(faculty) {
            const modal = document.getElementById('edit-faculty-modal');
            modal.querySelector('#edit-faculty-id').value = faculty.faculty_id;
            modal.querySelector('#edit-faculty-full-name').value = faculty.full_name;
            modal.querySelector('#edit-faculty-email').value = faculty.email;
            modal.querySelector('#edit-faculty-password').value = '';
            openModal('edit-faculty-modal');
        }

        document.getElementById('edit-faculty-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            if (!data.fullName.trim() || !data.email.trim()) {
                alert('Full Name and Email are required.');
                return;
            }
            data.deptId = hodDeptId;
            try {
                await fetchWithErrorHandling('/api/update-faculty', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                closeModal('edit-faculty-modal');
                await loadFaculty();
            } catch (error) {
                console.error('Error updating faculty:', error);
                alert(`Failed to update faculty: ${error.message}`);
            }
        });

        async function deleteFaculty(facultyId) {
            if (!confirm('Are you sure you want to delete this faculty?')) return;
            try {
                await fetchWithErrorHandling(`/api/delete-faculty?faculty_id=${encodeURIComponent(facultyId)}`, { method: 'DELETE' });
                await Promise.all([loadFaculty(), loadSubjects(), loadSubjectsForMarks()]);
            } catch (error) {
                console.error('Error deleting faculty:', error);
                alert(`Failed to delete faculty: ${error.message}`);
            }
        }

        async function loadSubjectsForTimetable(type, facultyId, semester) {
            try {
                let url = `/api/subjects?deptId=${encodeURIComponent(hodDeptId)}&course=${encodeURIComponent(defaultCourse)}`;
                if (type === 'faculty' && facultyId) url += `&facultyId=${encodeURIComponent(facultyId)}`;
                else if (type === 'semester' && semester) url += `&semester=${encodeURIComponent(semester)}`;
                else {
                    availableSubjects = [];
                    document.getElementById('slot-subject').innerHTML = '<option value="">Select Subject</option>';
                    return;
                }
                availableSubjects = await fetchWithErrorHandling(url);
                const select = document.getElementById('slot-subject');
                select.innerHTML = '<option value="">Select Subject</option>' +
                    availableSubjects.map(subject => {
                        const displayText = type === 'faculty' ? 
                            `${subject.subject_id} - ${subject.subject_name} (Semester ${subject.semester})` : 
                            `${subject.subject_id} - ${subject.subject_name}`;
                        return `<option value="${subject.subject_id}">${displayText}</option>`;
                    }).join('');
            } catch (error) {
                console.error('Error loading subjects for timetable:', error);
                alert(`Failed to load subjects: ${error.message}`);
            }
        }

        function initializeTimetableGrid() {
            const grid = document.getElementById('timetable-grid');
            grid.innerHTML = `
                <div class="header">Day</div>
                ${timeSlots.map(slot => `<div class="header">${slot}</div>`).join('')}
                ${days.map((day, dayIndex) => `
                    <div class="day">${day}</div>
                    ${timeSlots.map((slot, slotIndex) => slot === 'LUNCHBREAK' ?
                        `<div class="slot lunchbreak">LUNCHBREAK</div>` :
                        `<div class="slot" data-day="${dayIndex}" data-slot="${slotIndex + 1}" tabindex="0">Free</div>`
                    ).join('')}
                `).join('')}
            `;
            grid.addEventListener('click', handleSlotClick);
            grid.addEventListener('keydown', e => {
                if (e.key === 'Enter' && e.target.classList.contains('slot') && !e.target.classList.contains('lunchbreak')) {
                    const dayIndex = e.target.dataset.day;
                    const slotIndex = e.target.dataset.slot;
                    editSlot(parseInt(dayIndex), parseInt(slotIndex));
                }
            });
        }

        function handleSlotClick(e) {
            const slot = e.target.closest('.slot:not(.lunchbreak)');
            if (!slot) return;
            const dayIndex = parseInt(slot.dataset.day);
            const slotIndex = parseInt(slot.dataset.slot);
            editSlot(dayIndex, slotIndex);
        }

        async function editSlot(dayIndex, slotIndex) {
            const slot = document.querySelector(`.slot[data-day="${dayIndex}"][data-slot="${slotIndex}"]`);
            const select = document.getElementById('slot-subject');
            select.value = availableSubjects.find(s => `${s.subject_id} - ${s.subject_name}` === slot.textContent.trim())?.subject_id || '';
            document.getElementById('slot-input').style.display = 'flex';

            select.onchange = async () => {
                const subjectId = select.value;
                if (!subjectId) {
                    slot.textContent = 'Free';
                    slot.dataset.subjectId = '';
                    return;
                }
                const day = days[dayIndex];
                const slotTime = slotIndex;
                const semester = document.getElementById('create-timetable-semester').value || null;
                try {
                    const response = await fetchWithErrorHandling(`/api/check-faculty-conflict?subjectId=${subjectId}&day=${day}&slot=${slotTime}&semester=${semester || ''}`);
                    if (response.conflict) {
                        alert(`Can't assign, already assigned to semester ${response.semester}`);
                        select.value = '';
                        slot.textContent = 'Free';
                        slot.dataset.subjectId = '';
                        return;
                    }
                    slot.textContent = select.options[select.selectedIndex].text;
                    slot.dataset.subjectId = subjectId;
                } catch (error) {
                    console.error('Error checking conflict:', error);
                    alert(`Failed to check conflict: ${error.message}`);
                }
            };
        }

        function cancelSlotEdit() {
            document.getElementById('slot-input').style.display = 'none';
        }

        document.getElementById('create-timetable-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const timetableId = formData.get('timetableId');
            const type = formData.get('type');
            const facultyId = formData.get('facultyId');
            const semester = formData.get('semester');

            if (!type || (type === 'faculty' && !facultyId) || (type === 'semester' && !semester)) {
                alert('Please fill all required fields.');
                return;
            }

            const schedule = Array.from(document.querySelectorAll('.slot:not(.lunchbreak)'))
                .filter(slot => slot.textContent.trim() !== 'Free' && slot.dataset.subjectId)
                .map(slot => ({
                    day: days[parseInt(slot.dataset.day)],
                    slot: parseInt(slot.dataset.slot),
                    subject: slot.dataset.subjectId
                }));

            if (schedule.length === 0) {
                alert('Please add at least one subject to the timetable.');
                return;
            }

            const data = {
                timetable_id: timetableId || null,
                type,
                faculty_id: type === 'faculty' ? facultyId : null,
                semester: type === 'semester' ? semester : null,
                dept_id: hodDeptId,
                schedule
            };

            try {
                const endpoint = timetableId ? '/api/update-timetable' : '/api/create-timetable';
                const method = timetableId ? 'PUT' : 'POST';
                await fetchWithErrorHandling(endpoint, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                closeModal('create-timetable-modal');
                await loadTimetables();
            } catch (error) {
                console.error(`Error ${timetableId ? 'updating' : 'creating'} timetable:`, error);
                alert(`Failed to ${timetableId ? 'update' : 'create'} timetable: ${error.message}`);
            }
        });

        document.getElementById('create-timetable-type').addEventListener('change', function() {
            const type = this.value;
            document.getElementById('create-faculty-select-group').style.display = type === 'faculty' ? 'block' : 'none';
            document.getElementById('create-semester-select-group').style.display = type === 'semester' ? 'block' : 'none';
            loadSubjectsForTimetable(type, document.getElementById('create-timetable-faculty-id').value, document.getElementById('create-timetable-semester').value);
        });

        document.getElementById('create-timetable-faculty-id').addEventListener('change', function() {
            loadSubjectsForTimetable(document.getElementById('create-timetable-type').value, this.value, document.getElementById('create-timetable-semester').value);
        });

        document.getElementById('create-timetable-semester').addEventListener('change', function() {
            loadSubjectsForTimetable(document.getElementById('create-timetable-type').value, document.getElementById('create-timetable-faculty-id').value, this.value);
        });

        async function editTimetable(timetableId) {
            try {
                const timetable = await fetchWithErrorHandling(`/api/timetable-details?timetable_id=${timetableId}`);
                openModal('create-timetable-modal');

                document.getElementById('timetable-id').value = timetable.id;
                document.getElementById('create-timetable-title').textContent = 'Edit Timetable';
                document.getElementById('timetable-submit-btn').textContent = 'Update';

                const typeSelect = document.getElementById('create-timetable-type');
                typeSelect.value = timetable.type;
                typeSelect.dispatchEvent(new Event('change'));

                if (timetable.type === 'faculty') {
                    document.getElementById('create-timetable-faculty-id').value = timetable.faculty_id;
                } else {
                    document.getElementById('create-timetable-semester').value = timetable.semester;
                }

                await loadSubjectsForTimetable(timetable.type, timetable.faculty_id, timetable.semester);
                initializeTimetableGrid();

                timetable.schedule.forEach(slot => {
                    const dayIndex = days.indexOf(slot.day);
                    const slotIndex = slot.slot;
                    const gridSlot = document.querySelector(`.slot[data-day="${dayIndex}"][data-slot="${slotIndex}"]`);
                    if (gridSlot) {
                        gridSlot.textContent = slot.subject;
                        gridSlot.dataset.subjectId = slot.subject.split(' - ')[0];
                    }
                });
            } catch (error) {
                console.error('Error loading timetable for editing:', error);
                alert(`Failed to load timetable: ${error.message}`);
            }
        }

        async function loadTimetables() {
            const filterElement = document.getElementById('timetable-type-filter');
            const filter = filterElement ? filterElement.value : 'all';
            const container = document.getElementById('timetables-list');
            if (!container) {
                console.error('Timetables container not found');
                return;
            }
            container.innerHTML = '';

            try {
                const response = await fetchWithErrorHandling('/api/timetables');
                let timetables = response;

                if (filter !== '') {
                    timetables = timetables.filter(t => t.type === filter);
                }

                if (timetables.length === 0) {
                    container.innerHTML = '<p>No timetables found.</p>';
                    return;
                }

                for (const timetable of timetables) {
                    const div = document.createElement('div');
                    div.className = 'timetable-card';
                    const headerText = timetable.type === 'semester'
                        ? `Semester ${timetable.semester} (${timetable.dept_id})`
                        : `Faculty: ${timetable.faculty_name} (Dept: ${timetable.dept_id})`;
                    div.innerHTML = `
                        <h3>${headerText}</h3>
                        <table class="timetable-grid">
                            <thead>
                                <tr>
                                    <th></th>
                                    ${timeSlots.map((_, i) => `<th>${timeSlots[i]}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${days.map(day => `
                                    <tr>
                                        <td>${day}</td>
                                        ${timeSlots.map((_, slotIndex) => {
                                            const slot = timetable.schedule.find(s => s.day === day && s.slot === slotIndex + 1);
                                            if (!slot) return `<td>Free</td>`;
                                            if (timetable.type === 'faculty') {
                                                return `<td>${slot.subject}<br>(Sem ${slot.semester}, ${timetable.dept_id})</td>`;
                                            }
                                            return `<td>${slot.subject}</td>`;
                                        }).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <button class="btn btn-edit" onclick="editTimetable(${timetable.id})">Edit</button>
                        <button class="btn btn-delete" onclick="deleteTimetable(${timetable.id})">Delete</button>
                    `;
                    container.appendChild(div);
                }
            } catch (error) {
                console.error('Error loading timetables:', error);
                container.innerHTML = '<p>Failed to load timetables.</p>';
            }
        }

        async function deleteTimetable(timetableId) {
            if (!confirm('Are you sure you want to delete this timetable?')) return;
            try {
                await fetchWithErrorHandling(`/api/delete-timetable?timetable_id=${timetableId}`, { method: 'DELETE' });
                await loadTimetables();
            } catch (error) {
                console.error('Error deleting timetable:', error);
                alert(`Failed to delete timetable: ${error.message}`);
            }
        }

        document.getElementById('upload-timetable-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(event) {
                const text = event.target.result;
                const rows = text.split('\n').map(row => row.split(',').map(cell => cell.trim()));
                if (rows.length < 2 || rows[0].join(',') !== 'Type,Identifier,Day,Slot,Subject') {
                    alert('Invalid CSV format. Expected headers: Type,Identifier,Day,Slot,Subject');
                    return;
                }
                const schedule = rows.slice(1).filter(row => row.length >= 5).map(row => ({
                    day: row[2],
                    slot: parseInt(row[3]),
                    subject: row[4]
                }));
                const data = {
                    type: rows[1][0].toLowerCase(),
                    faculty_id: rows[1][0].toLowerCase() === 'faculty' ? rows[1][1] : null,
                    semester: rows[1][0].toLowerCase() === 'semester' ? rows[1][1] : null,
                    dept_id: hodDeptId,
                    schedule
                };
                try {
                    await fetchWithErrorHandling('/api/upload-timetable', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    e.target.value = '';
                    await loadTimetables();
                } catch (error) {
                    console.error('Error uploading timetable:', error);
                    alert(`Failed to upload timetable: ${error.message}`);
                }
            };
            reader.readAsText(file);
        });

        async function loadMarks() {
            try {
                const semester = document.getElementById('marks-semester-filter').value;
                const course = document.getElementById('marks-course-filter').value;
                const subjectId = document.getElementById('marks-subject-filter').value;
                if (!semester || !course || !subjectId) {
                    document.querySelector('#marks-table tbody').innerHTML = '';
                    return;
                }
                const url = `/api/hod-marks?deptId=${encodeURIComponent(hodDeptId)}&semester=${semester}&course=${encodeURIComponent(course)}&subjectId=${encodeURIComponent(subjectId)}`;
                const marks = await fetchWithErrorHandling(url);
                const tbody = document.querySelector('#marks-table tbody');
                tbody.innerHTML = marks.map(mark => {
                    const total = [mark['Assignment 1'], mark['Assignment 2'], mark['Assignment 3']]
                        .reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
                    return `
                        <tr>
                            <td>${mark.roll_number}</td>
                            <td>${mark.subject_id}</td>
                            <td>${mark.subject_name}</td>
                            <td>${mark.semester}</td>
                            <td>${mark['Assignment 1'] || '-'}</td>
                            <td>${mark['Assignment 2'] || '-'}</td>
                            <td>${mark['Assignment 3'] || '-'}</td>
                            <td>${total > 0 ? total.toFixed(1) : '-'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading marks:', error);
                alert(`Failed to load marks: ${error.message}`);
            }
        }

        async function loadSubjectsForMarks() {
            try {
                const semester = document.getElementById('marks-semester-filter').value;
                const course = document.getElementById('marks-course-filter').value || defaultCourse;
                let url = `/api/subjects?deptId=${encodeURIComponent(hodDeptId)}&course=${encodeURIComponent(course)}`;
                if (semester) url += `&semester=${encodeURIComponent(semester)}`;
                const subjects = await fetchWithErrorHandling(url);
                document.getElementById('marks-subject-filter').innerHTML = '<option value="">Select Subject</option>' +
                    subjects.map(subject => `<option value="${subject.subject_id}">${subject.subject_id} - ${subject.subject_name}</option>`).join('');
            } catch (error) {
                console.error('Error loading subjects for marks:', error);
                alert(`Failed to load subjects for marks: ${error.message}`);
            }
        }

        document.getElementById('subject-course-filter').addEventListener('change', loadSubjects);
        document.getElementById('subject-semester-filter').addEventListener('change', loadSubjects);
        document.getElementById('student-course-filter').addEventListener('change', loadStudents);
        document.getElementById('student-semester-filter').addEventListener('change', loadStudents);
        document.getElementById('timetable-type-filter').addEventListener('change', loadTimetables);
        document.getElementById('marks-semester-filter').addEventListener('change', () => { loadSubjectsForMarks(); loadMarks(); });
        document.getElementById('marks-course-filter').addEventListener('change', () => { loadSubjectsForMarks(); loadMarks(); });
        document.getElementById('marks-subject-filter').addEventListener('change', loadMarks);

     
        loadHODDetails();
    </script>
</body>
</html>